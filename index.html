<!doctype html>
<html lang="vi">

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Đánh Giá MBTI + Định Hướng Nghề Nghiệp</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" defer></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: Arial, sans-serif;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        @media (min-width: 768px) {
            .container {
                padding: 30px;
            }
        }

        .container-title {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            color: #4a5568;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        @media (min-width: 768px) {
            .container-title {
                font-size: 28px;
            }
        }

        .container-greeting {
            background: linear-gradient(45deg, #f8f9ff, #e8f4f8);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin-bottom: 30px;
        }

        .question {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        @media (min-width: 768px) {
            .question {
                padding: 20px;
            }
        }

        .question-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 15px;
        }

        .required {
            color: #e53e3e;
        }

        .form-check {
            margin-bottom: 10px;
            padding: 8px;
        }

        .form-check:hover {
            background-color: #e2e8f0;
            border-radius: 5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin: 10px;
            max-height: 90vh;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .modal-content {
                margin: 0;
            }
        }

        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .mbti-result {
            text-align: center;
            padding: 20px;
        }

        .mbti-type {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .breakdown-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .breakdown-letter {
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
        }

        .summary-section {
            background: linear-gradient(45deg, #f8f9ff, #e8f4f8);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .section-heading {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 12px;
        }

        .career-card {
            background: #f8f9fa;
            border-left: 4px solid #764ba2;
            border-radius: 8px;
            padding: 16px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="container-title">Đánh Giá MBTI &amp; Tư Vấn Nghề Nghiệp</div>
        <div class="container-greeting text-center">
            <h5>Hệ thống đánh giá tính cách MBTI giúp bạn hiểu rõ bản thân và đưa ra lời khuyên phù hợp cho định hướng
                ngành học &amp; nghề nghiệp.</h5>
            <br>
            <i>Vui lòng trả lời đầy đủ các câu hỏi có dấu <span class="required">*</span> rồi bấm <b>Nộp kết
                    quả</b>.</i>
        </div>

        <div id="container-content">
            <div class="py-3 text-center">
                <hr width="50%" class="mx-auto">
            </div>

            <!-- Quiz renders here -->
            <form id="quiz-form"></form>

            <!-- Career inputs -->
            <div class="question">
                <div class="question-title">Thông tin định hướng nghề nghiệp (tuỳ chọn)</div>
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label for="currentJob" class="form-label">Bạn đang làm gì / định ngành hiện tại?</label>
                        <input id="currentJob" class="form-control"
                            placeholder="Ví dụ: Học sinh lớp 12, yêu thích Toán-Lý-IT">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Bạn đang phân vân giữa 2 lựa chọn?</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Lựa chọn 1</span>
                            <input id="optionA" class="form-control" placeholder="Ví dụ: Kỹ sư phần mềm">
                        </div>
                        <div class="input-group">
                            <span class="input-group-text">Lựa chọn 2</span>
                            <input id="optionB" class="form-control" placeholder="Ví dụ: Marketing số">
                        </div>
                    </div>
                </div>
            </div>

            <div class="question-write-container" data-type="text">
                <div class="quìz-form-button text-center">
                    <button id="button-submit" type="button" class="btn btn-primary mt-3">
                        Nộp kết quả
                    </button>
                    <br><br>
                    <i>Các phần <span class="required">*</span> là bắt buộc cho phần MBTI. Phần định hướng nghề nghiệp
                        là <b>không bắt buộc</b>, nhưng nên điền nếu bạn muốn gợi ý ngành học.</i>
                </div>
            </div>
        </div>

        <!-- Loading Modal -->
        <div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Đang phân tích kết quả...</h5>
                    </div>
                    <div class="modal-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Kết quả của bạn đang được phân tích. Vui lòng chờ trong giây lát...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Result Modal -->
        <div class="modal fade" id="resultModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Kết Quả</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="resultContent"><!-- render here --></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="button" class="btn btn-primary" onclick="restartQuiz()">Làm lại</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====== CONFIG ======
        const GEMINI_API_KEY = "AIzaSyA6RDY_Jlj5KjN8a85QVk8U2jLJ3Hg50sY"; // ĐỪNG commit key thật vào client

        // 20 câu hỏi (5 câu cho từng cặp EI, SN, TF, JP). Câu trả lời A/B cố gắng cân bằng theo cặp.
        const QUESTIONS = [
            // E vs I
            { id: 'q1', dim: 'EI', text: 'Bạn cảm thấy năng lượng đến từ đâu?', a: 'Từ việc giao tiếp và tương tác với mọi người.', b: 'Từ thời gian một mình, suy nghĩ sâu về những gì đang xảy ra.' },
            { id: 'q2', dim: 'EI', text: 'Trong sự kiện đông người, bạn thường...', a: 'Chủ động bắt chuyện và kết nối.', b: 'Quan sát, chỉ tham gia khi cần.' },
            { id: 'q3', dim: 'EI', text: 'Một ngày lý tưởng của bạn là...', a: 'Hoạt động cùng nhóm/CLB, nhiều tương tác.', b: 'Tự học/tự làm việc, không bị gián đoạn.' },
            { id: 'q4', dim: 'EI', text: 'Khi có ý tưởng mới, bạn...', a: 'Muốn nói ra và thảo luận ngay.', b: 'Muốn suy nghĩ kỹ trước khi chia sẻ.' },
            { id: 'q5', dim: 'EI', text: 'Về phong cách giao tiếp, bạn...', a: 'Thích nói trực tiếp, phản hồi nhanh.', b: 'Thích nhắn tin hoặc suy nghĩ rồi mới trả lời.' },
            // S vs N
            { id: 'q6', dim: 'SN', text: 'Khi học một chủ đề mới, bạn thích...', a: 'Ví dụ cụ thể, quy trình rõ ràng.', b: 'Ý tưởng tổng quan, mô hình/khả năng tương lai.' },
            { id: 'q7', dim: 'SN', text: 'Bạn tin tưởng hơn vào...', a: 'Dữ kiện, trải nghiệm có thể kiểm chứng.', b: 'Trực giác, mối liên hệ trừu tượng.' },
            { id: 'q8', dim: 'SN', text: 'Trong bài tập dự án, bạn...', a: 'Tập trung vào chi tiết, yêu cầu cụ thể.', b: 'Khám phá phương án mới, cải tiến cách làm.' },
            { id: 'q9', dim: 'SN', text: 'Với xu hướng học tập, bạn...', a: 'Muốn “làm đúng” theo hướng dẫn.', b: 'Muốn “hiểu sâu” để sáng tạo cách riêng.' },
            { id: 'q10', dim: 'SN', text: 'Khi đánh giá thông tin, bạn...', a: 'Ưu tiên dữ liệu hiện có.', b: 'Đặt câu hỏi “nếu… thì…”, hình dung tương lai.' },
            // T vs F
            { id: 'q11', dim: 'TF', text: 'Bạn thường ưu tiên điều gì khi ra quyết định?', a: 'Lý trí, phân tích các yếu tố khách quan.', b: 'Cảm xúc và tác động đến mọi người.' },
            { id: 'q12', dim: 'TF', text: 'Trong tranh luận, bạn...', a: 'Thích lập luận logic, thẳng thắn.', b: 'Thích hoà giải, giữ cảm xúc tích cực.' },
            { id: 'q13', dim: 'TF', text: 'Khi góp ý bạn bè, bạn...', a: 'Nói thẳng điểm cần cải thiện.', b: 'Nói khéo để người nghe không buồn.' },
            { id: 'q14', dim: 'TF', text: 'Với xung đột, bạn...', a: 'Giải quyết theo nguyên tắc/công bằng.', b: 'Ưu tiên mối quan hệ/hoàn cảnh cụ thể.' },
            { id: 'q15', dim: 'TF', text: 'Bạn thấy “đúng-sai” quan trọng hơn hay “tình cảm” quan trọng hơn?', a: 'Đúng-sai/tiêu chuẩn.', b: 'Tình cảm/mối quan hệ.' },
            // J vs P
            { id: 'q16', dim: 'JP', text: 'Bạn thích làm gì hơn trong công việc/học tập?', a: 'Theo kế hoạch rõ ràng, có tổ chức.', b: 'Linh hoạt, tuỳ cơ ứng biến.' },
            { id: 'q17', dim: 'JP', text: 'Khi phải hoàn thành một công việc, bạn sẽ...', a: 'Lập kế hoạch và làm ngay.', b: 'Tìm thêm thông tin rồi điều chỉnh dần.' },
            { id: 'q18', dim: 'JP', text: 'Bạn cảm thấy sao về kế hoạch và lịch trình?', a: 'Thích kỷ luật, tuân thủ thời hạn.', b: 'Thích linh hoạt, không quá gò bó.' },
            { id: 'q19', dim: 'JP', text: 'Kiểu công việc ưa thích?', a: 'Yêu cầu rõ, tiêu chí cụ thể.', b: 'Sáng tạo, có không gian thử nghiệm.' },
            { id: 'q20', dim: 'JP', text: 'Trước kỳ thi/đ deadline, bạn...', a: 'Chuẩn bị sớm theo checklist.', b: 'Tăng tốc nước rút khi gần tới hạn.' }
        ];

        // ====== RENDER QUIZ ======
        window.addEventListener('DOMContentLoaded', () => {
            renderQuiz();
            document.getElementById('button-submit').addEventListener('click', submitQuiz);
        });

        function renderQuiz() {
            const form = document.getElementById('quiz-form');
            form.innerHTML = '';

            QUESTIONS.forEach((q, idx) => {
                const qEl = document.createElement('div');
                qEl.className = 'question';
                qEl.innerHTML = `
          <div class="question-title">${idx + 1}. ${q.text} <span class="required">*</span></div>
          <div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="${q.id}" id="${q.id}-a" value="a) ${q.a}">
              <label class="form-check-label" for="${q.id}-a">a) ${q.a}</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="${q.id}" id="${q.id}-b" value="b) ${q.b}">
              <label class="form-check-label" for="${q.id}-b">b) ${q.b}</label>
            </div>
          </div>`;
                form.appendChild(qEl);
            });
        }

        // ====== SUBMIT FLOW ======
        function submitQuiz() {
            // Validate all answered
            const form = document.getElementById('quiz-form');
            const formData = new FormData(form);
            const answers = {};
            let allAnswered = true;

            for (const q of QUESTIONS) {
                const ans = formData.get(q.id);
                if (!ans) { allAnswered = false; break; }
                answers[q.id] = ans;
            }

            if (!allAnswered) {
                alert('Vui lòng trả lời tất cả các câu hỏi trước khi nộp bài!');
                return;
            }

            // Show loading
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            loadingModal.show();

            analyzeResults(answers)
                .catch(err => {
                    console.error(err);
                    alert('Có lỗi xảy ra khi phân tích kết quả. Vui lòng thử lại!');
                })
                .finally(() => loadingModal.hide());
        }

        // ====== LLM CALLS ======
        async function analyzeResults(answers) {
            // Build plain text answers for MBTI prompt
            let answersText = '';
            Object.entries(answers).forEach(([qid, answer], i) => {
                answersText += `Câu ${i + 1}: ${answer}\n`;
            });

            const prompt1 = `Bạn là chuyên gia MBTI. Hãy chấm loại MBTI dựa trên 20 câu trả lời A/B dưới đây.
# YÊU CẦU ĐẦU RA (bắt buộc JSON theo schema):
- Gồm 3 phần: Kết quả, Phân tích kết quả, Tóm tắt MBTI.
- "Kết quả": chỉ ghi loại MBTI (một trong 16 loại: ISTJ, ISFJ, INFJ, INTJ, ISTP, ISFP, INFP, INTP, ESTP, ESFP, ENFP, ENTP, ESTJ, ESFJ, ENFJ, ENTJ).
- "Phân tích kết quả": giải thích đầy đủ 4 chữ cái theo 4 cặp EI, SN, TF, JP.
- "Tóm tắt MBTI": tóm tắt vài câu, súc tích.
- KHÔNG thêm bình luận khác, KHÔNG gợi ý nghề nghiệp ở prompt này.

# DỮ LIỆU CÂU TRẢ LỜI (A/B):
${answersText}`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${encodeURIComponent(GEMINI_API_KEY)}`;

            const payload1 = {
                contents: [{ role: 'user', parts: [{ text: prompt1 }] }],
                generationConfig: {
                    response_mime_type: 'application/json',
                    response_schema: {
                        type: 'OBJECT',
                        properties: {
                            mbti_result: {
                                type: 'OBJECT',
                                properties: {
                                    MBTI: { type: 'STRING' },
                                    breakdown: {
                                        type: 'ARRAY',
                                        items: {
                                            type: 'OBJECT', required: ['letter', 'describe'],
                                            properties: { letter: { type: 'STRING' }, describe: { type: 'STRING' } }
                                        }
                                    },
                                    summary: { type: 'STRING' }
                                }
                            }
                        }
                    }
                }
            };

            const res1 = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload1) });
            if (!res1.ok) throw new Error(`HTTP ${res1.status}: ${await res1.text()}`);
            const data1 = await res1.json();
            const parsed1 = JSON.parse(data1?.candidates?.[0]?.content?.parts?.[0]?.text || '{}');
            const mbti = parsed1?.mbti_result?.MBTI || 'NA';

            // Try optional career guidance if user provided inputs
            const currentJob = document.getElementById('currentJob').value?.trim();
            const optionA = document.getElementById('optionA').value?.trim();
            const optionB = document.getElementById('optionB').value?.trim();

            let career = null;
            if (mbti && (currentJob || (optionA && optionB))) {
                const prompt2 = buildCareerPrompt({
                    mbtiResult: JSON.stringify(parsed1.mbti_result),
                    currentJob,
                    optionA,
                    optionB
                });

                const payload2 = {
                    contents: [{ role: 'user', parts: [{ text: prompt2 }] }],
                    generationConfig: {
                        response_mime_type: 'application/json',
                        response_schema: {
                            type: 'OBJECT',
                            properties: {
                                career_guidance: {
                                    type: 'OBJECT',
                                    properties: {
                                        pick: { type: 'STRING', description: 'Tên lựa chọn được khuyên (hoặc Option A/B nếu không có tên). Chỉ MỘT hướng.' },
                                        rationale: { type: 'STRING', description: 'Lý do ngắn gọn, 3-6 câu.' }
                                    }
                                }
                            }
                        }
                    }
                };

                const res2 = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload2) });
                if (res2.ok) {
                    const data2 = await res2.json();
                    const parsed2 = JSON.parse(data2?.candidates?.[0]?.content?.parts?.[0]?.text || '{}');
                    career = parsed2?.career_guidance || null;
                }
            }

            displayResult(parsed1?.mbti_result, career);
        }

        function buildCareerPrompt({ mbtiResult, currentJob, optionA, optionB }) {
            // Prompt bạn đưa — đã chỉnh lại cho chặt chẽ & ràng buộc đầu ra JSON
            return `Bạn là chuyên gia định hướng ngành học & nghề nghiệp cho học sinh lớp 12.
# DỮ LIỆU ĐẦU VÀO
- KẾT QUẢ MBTI (JSON): ${mbtiResult}
- Hiện tại: ${currentJob || '(không cung cấp)'}
- Phân vân giữa: ${optionA || '(A?)'} và ${optionB || '(B?)'}

# NHIỆM VỤ
- Dựa trên MBTI (đặc biệt phần breakdown), bối cảnh hiện tại, và hai lựa chọn đã nêu.
- Hãy LỰA CHỌN DỨT KHOÁT MỘT HƯỚNG (chỉ 1) phù hợp nhất.
- Trình bày ngắn gọn lý do (3–6 câu). Không liệt kê lộ trình/goal, không đề xuất thêm nghề khác ngoài 2 lựa chọn.
- Không mời gọi thiết kế mục tiêu sự nghiệp.

# ĐẦU RA (bắt buộc JSON theo schema):
{
  "career_guidance": {
    "pick": "<ghi chính xác tên lựa chọn được khuyên – hoặc Option A/B nếu thiếu>",
    "rationale": "<3–6 câu lý do, dựa vào MBTI và bối cảnh>"
  }
}`;
        }

        // ====== RENDER RESULTS ======
        function displayResult(mbtiResult, career) {
            const resultContent = document.getElementById('resultContent');

            let html = '';

            if (mbtiResult) {
                html += `
        <div class="mbti-result">
          <div class="mbti-type">${escapeHTML(mbtiResult.MBTI || '')}</div>
          <h4 class="section-heading">Phân Tích Kết Quả</h4>
        </div>`;

                if (Array.isArray(mbtiResult.breakdown)) {
                    mbtiResult.breakdown.forEach(item => {
                        html += `
              <div class="breakdown-item">
                <div class="breakdown-letter">${escapeHTML(item.letter || '')}</div>
                <div>${escapeHTML(item.describe || '')}</div>
              </div>`;
                    });
                }

                if (mbtiResult.summary) {
                    html += `
            <div class="summary-section">
              <h5 class="section-heading">Tóm Tắt MBTI</h5>
              <p>${escapeHTML(mbtiResult.summary)}</p>
            </div>`;
                }
            }

            // Career guidance (optional)
            if (career) {
                html += `
          <hr class="my-4">
          <h4 class="section-heading">Định Hướng Nghề Nghiệp / Ngành Học</h4>
          <div class="career-card">
            <p><b>Khuyến nghị:</b> ${escapeHTML(career.pick || '')}</p>
            <p><b>Lý do:</b> ${escapeHTML(career.rationale || '')}</p>
          </div>`;
            }

            resultContent.innerHTML = html;

            const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
            resultModal.show();
        }

        function restartQuiz() {
            document.getElementById('quiz-form').reset();
            renderQuiz();
            const resultModal = bootstrap.Modal.getInstance(document.getElementById('resultModal'));
            if (resultModal) resultModal.hide();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ====== UTILS ======
        function escapeHTML(str) {
            return (str || '').toString().replace(/[&<>"']/g, (c) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            })[c]);
        }
    </script>
</body>

</html>